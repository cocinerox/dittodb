<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Getting Started with `dittodb` • dittodb</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Getting Started with `dittodb`">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-150741105-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-150741105-1');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dittodb</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/dittodb.html">Get started</a>
</li>
<li>
  <a href="../reference/">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/dittodb.html">Getting Started with dittodb</a>
    </li>
    <li>
      <a href="../articles/travelling.html">Recording SQL queries with dittodb for travelling</a>
    </li>
    <li>
      <a href="../articles/nycflights.html">nycflights data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jonkeane/dittodb">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Getting Started with <code>dittodb</code>
</h1>
                        <h4 class="author">Jonathan Keane</h4>
            
            <h4 class="date">2020-04-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jonkeane/dittodb/blob/master/vignettes/dittodb.Rmd"><code>vignettes/dittodb.Rmd</code></a></small>
      <div class="hidden name"><code>dittodb.Rmd</code></div>

    </div>

    
    
<p><code>dittodb</code> is designed to make it easy and fun to test functions that interact with a database. It works by looking for mock responses for each query you send while you run your tests and will seamlessly pretend that those mocks were provided by the database connection without needing a connection at all.</p>
<p>To get started, imagine that we are working on a package that queries a database that consists of the <a href="nycflights.html">nycflights13 data</a>. We have the following function which takes a column to aggregate by and returns a dataframe with that column and the mean delay for groups based on the values in the column name given.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(DBI)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(RMariaDB)</span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a>mean_delays &lt;-<span class="st"> </span><span class="cf">function</span>(group_col) {</span>
<span id="cb1-5"><a href="#cb1-5"></a>  con &lt;-<span class="st"> </span><span class="kw"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span>(</span>
<span id="cb1-6"><a href="#cb1-6"></a>    RMariaDB<span class="op">::</span><span class="kw"><a href="https://rmariadb.r-dbi.org/reference/dbConnect-MariaDBDriver-method.html">MariaDB</a></span>(),</span>
<span id="cb1-7"><a href="#cb1-7"></a>    <span class="dt">dbname =</span> <span class="st">"nycflights"</span>,</span>
<span id="cb1-8"><a href="#cb1-8"></a>    <span class="dt">host =</span> <span class="st">"127.0.0.1"</span>,</span>
<span id="cb1-9"><a href="#cb1-9"></a>    <span class="dt">username =</span> <span class="st">"travis"</span>,</span>
<span id="cb1-10"><a href="#cb1-10"></a>    <span class="dt">password =</span> <span class="st">""</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>  )</span>
<span id="cb1-12"><a href="#cb1-12"></a>  <span class="kw"><a href="https://rdrr.io/r/base/on.exit.html">on.exit</a></span>(<span class="kw"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html">dbDisconnect</a></span>(con))</span>
<span id="cb1-13"><a href="#cb1-13"></a>  </span>
<span id="cb1-14"><a href="#cb1-14"></a>  query &lt;-<span class="st"> </span>glue<span class="op">::</span><span class="kw"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(</span>
<span id="cb1-15"><a href="#cb1-15"></a>    <span class="st">"SELECT {group_col}, AVG(arr_delay) as mean_delay from nycflights13.flights "</span>,</span>
<span id="cb1-16"><a href="#cb1-16"></a>    <span class="st">"WHERE arr_delay &gt; 0 GROUP BY {group_col}"</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>  )</span>
<span id="cb1-18"><a href="#cb1-18"></a>  </span>
<span id="cb1-19"><a href="#cb1-19"></a>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span>(con, query))</span>
<span id="cb1-20"><a href="#cb1-20"></a>}</span></code></pre></div>
<p>If we give it the column <code>"month"</code>, we get the following dataframe:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">mean_delays</span>(<span class="st">"month"</span>)</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw"><a href="../reference/mockdb.html">with_mock_db</a></span>(<span class="kw">mean_delays</span>(<span class="st">"month"</span>))</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co">#&gt;    month mean_delay</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co">#&gt; 1      1   34.47749</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co">#&gt; 2      2   33.68921</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">#&gt; 3      3   40.57166</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co">#&gt; 4      4   42.73958</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co">#&gt; 5      5   41.88586</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="co">#&gt; 6      6   53.73827</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co">#&gt; 7      7   53.95152</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co">#&gt; 8      8   39.51294</span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co">#&gt; 9      9   38.80555</span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="co">#&gt; 10    10   29.03665</span></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="co">#&gt; 11    11   27.48459</span></span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="co">#&gt; 12    12   39.72725</span></span></code></pre></div>
<p>Great, now that we have our function we want to test it to make sure it is operating as expected. Normally, we could write something like:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(testthat)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dittodb)</span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="kw"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span>(<span class="st">"mean_delays()"</span>, {</span>
<span id="cb4-5"><a href="#cb4-5"></a>  out &lt;-<span class="st"> </span><span class="kw">mean_delays</span>(<span class="st">"month"</span>)</span>
<span id="cb4-6"><a href="#cb4-6"></a>  <span class="kw"><a href="https://testthat.r-lib.org/reference/expect_named.html">expect_named</a></span>(out, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"month"</span>, <span class="st">"mean_delay"</span>))</span>
<span id="cb4-7"><a href="#cb4-7"></a>  <span class="kw"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(out), <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">12</span>, <span class="dv">2</span>))</span>
<span id="cb4-8"><a href="#cb4-8"></a>})</span></code></pre></div>
<p>And this works just fine if we only ever run your tests locally, but if we want to <a href="http://r-pkgs.had.co.nz/check.html#check">run our tests with a Continuous Integration system</a> (and yes, we want to do that!), this won’t work without first setting up our production database of flights. For our tests, we don’t actually need to connect to the database and get new data (and, in fact, that would make some tests fail erroneously suddenly if the underlying changed). Instead, what we want is to take a snapshot of running the test code, and then be able to use that recorded snapshot when we run tests later.</p>
<div id="recording-snapshots" class="section level2">
<h2 class="hasAnchor">
<a href="#recording-snapshots" class="anchor"></a>Recording snapshots</h2>
<p>We can record snapshots of the database interactions with the commands <code><a href="../reference/capture_requests.html">start_db_capturing()</a></code>, run the functions we want to record, and then stop recording with <code><a href="../reference/capture_requests.html">stop_db_capturing()</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw"><a href="../reference/capture_requests.html">start_db_capturing</a></span>()</span>
<span id="cb5-2"><a href="#cb5-2"></a>out &lt;-<span class="st"> </span><span class="kw">mean_delays</span>(<span class="st">"month"</span>)</span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="kw"><a href="../reference/capture_requests.html">stop_db_capturing</a></span>()</span></code></pre></div>
<p>This will write a new folder (by default in <code>./tests/testthat/</code>) with the name of the database (here: <code>nycflights</code>) and then write one file with the name <code>SELECT-e53189.R</code> which is the snapshot for this example. This <code>SELECT-*</code> file contains the data that was received from the database for use in tests.</p>
</div>
<div id="with_mock_db" class="section level2">
<h2 class="hasAnchor">
<a href="#with_mock_db" class="anchor"></a><code>with_mock_db()</code>
</h2>
<p>Now that we have a snapshot, we can use that snapshot by wrapping our call that includes a database interaction with the function <code><a href="../reference/mockdb.html">with_mock_db()</a></code>. This will look for snapshots and use those.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw"><a href="../reference/mockdb.html">with_mock_db</a></span>(</span>
<span id="cb6-2"><a href="#cb6-2"></a>  <span class="kw">mean_delays</span>(<span class="st">"month"</span>)</span>
<span id="cb6-3"><a href="#cb6-3"></a>)</span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co">#&gt;    month mean_delay</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">#&gt; 1      1   34.47749</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co">#&gt; 2      2   33.68921</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co">#&gt; 3      3   40.57166</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co">#&gt; 4      4   42.73958</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="co">#&gt; 5      5   41.88586</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="co">#&gt; 6      6   53.73827</span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="co">#&gt; 7      7   53.95152</span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="co">#&gt; 8      8   39.51294</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="co">#&gt; 9      9   38.80555</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="co">#&gt; 10    10   29.03665</span></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co">#&gt; 11    11   27.48459</span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="co">#&gt; 12    12   39.72725</span></span></code></pre></div>
<p>So, now we can write our tests like:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(testthat)</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dittodb)</span>
<span id="cb7-3"><a href="#cb7-3"></a></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="kw"><a href="../reference/mockdb.html">with_mock_db</a></span>(</span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="kw"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span>(<span class="st">"mean_delays()"</span>, {</span>
<span id="cb7-6"><a href="#cb7-6"></a>    out &lt;-<span class="st"> </span><span class="kw">mean_delays</span>(<span class="st">"month"</span>)</span>
<span id="cb7-7"><a href="#cb7-7"></a>    <span class="kw"><a href="https://testthat.r-lib.org/reference/expect_named.html">expect_named</a></span>(out, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"month"</span>, <span class="st">"mean_delay"</span>))</span>
<span id="cb7-8"><a href="#cb7-8"></a>    <span class="kw"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(out), <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">12</span>, <span class="dv">2</span>))</span>
<span id="cb7-9"><a href="#cb7-9"></a>  })</span>
<span id="cb7-10"><a href="#cb7-10"></a>)</span></code></pre></div>
<p>When placed inside of <code><a href="../reference/mockdb.html">with_mock_db(...)</a></code> a call to <code>mean_delays("month")</code> will return what we saved as our snapshot <em>as if it had actually connected to the database</em> without needing the database to be installed, reachable, or operational.</p>
<p>If we wanted to test that a day-based aggregation works, we can, although we will have to make a new snapshot. First we would run the following interactively:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw"><a href="../reference/capture_requests.html">start_db_capturing</a></span>()</span>
<span id="cb8-2"><a href="#cb8-2"></a>out &lt;-<span class="st"> </span><span class="kw">mean_delays</span>(<span class="st">"day"</span>)</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="kw"><a href="../reference/capture_requests.html">stop_db_capturing</a></span>()</span></code></pre></div>
<p>This will create a new file (<code>SELECT-16d120.R</code>) which contains the response when aggregating by day. dittodb saves each database interaction with a hash of the query that is sent, so that a number of different responses from a database can be saved and the correct one will be used when called inside of <code><a href="../reference/mockdb.html">with_mock_db(...)</a></code>. So now, we could write our new test with:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw"><a href="../reference/mockdb.html">with_mock_db</a></span>(</span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="kw"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span>(<span class="st">"mean_delays()"</span>, {</span>
<span id="cb9-3"><a href="#cb9-3"></a>    out &lt;-<span class="st"> </span><span class="kw">mean_delays</span>(<span class="st">"day"</span>)</span>
<span id="cb9-4"><a href="#cb9-4"></a>    <span class="kw"><a href="https://testthat.r-lib.org/reference/expect_named.html">expect_named</a></span>(out, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"day"</span>, <span class="st">"mean_delay"</span>))</span>
<span id="cb9-5"><a href="#cb9-5"></a>    <span class="kw"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(out), <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">31</span>, <span class="dv">2</span>))</span>
<span id="cb9-6"><a href="#cb9-6"></a>  })</span>
<span id="cb9-7"><a href="#cb9-7"></a>)</span></code></pre></div>
</div>
<div id="things-to-be-careful-about" class="section level2">
<h2 class="hasAnchor">
<a href="#things-to-be-careful-about" class="anchor"></a>Things to be careful about</h2>
<p>There are a few things to be careful about when using dittodb.</p>
<div id="when-to-call-dbconnect" class="section level3">
<h3 class="hasAnchor">
<a href="#when-to-call-dbconnect" class="anchor"></a>When to call <code>dbConnect()</code>
</h3>
<p>Always call <code><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect()</a></code> inside of <code><a href="../reference/mockdb.html">with_mock_db(...)</a></code>. You can make as many calls as you want to the mock database inside of a <code><a href="../reference/mockdb.html">with_mock_db(...)</a></code>, but you should always make sure that you connect to the database inside of and not outside of <code><a href="../reference/mockdb.html">with_mock_db(...)</a></code>. This is because when you “connect” to the mock database, a few variables are set that tell dittodb where to look for mocks. It’s less important (though still a good idea) to call <code><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html">dbDisconnect()</a></code> inside of <code><a href="../reference/mockdb.html">with_mock_db()</a></code>. This is also true when recording snapshots with <code>start_db_recording()</code>, you should start the recording and then call <code><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect()</a></code>.</p>
</div>
<div id="query-size" class="section level3">
<h3 class="hasAnchor">
<a href="#query-size" class="anchor"></a>Query size</h3>
<p>Recording snapshots saves the whole query to disk in a relatively inefficient way (from a data storage perspective), so be careful with what you save. And you’ll want to not save extremely large results if at all possible. This is also a best-practice for writing tests anyway: you should have mocks that are as minimal as possible to test the functionality you need to. Minimal mocks make it easier to change things that aren’t relevant to the test (you don’t have to change the way data is represented if it’s not important to what you’re testing) and it makes your tests run faster.</p>
</div>
</div>
<div id="advanced-uses" class="section level2">
<h2 class="hasAnchor">
<a href="#advanced-uses" class="anchor"></a>Advanced uses</h2>
<p>There are a number of advanced features that might be useful. However they take a bit of configuration to use.</p>
<div id="specify-a-new-path" class="section level3">
<h3 class="hasAnchor">
<a href="#specify-a-new-path" class="anchor"></a>Specify a new path</h3>
<p>You can control where mocks are read from (when you’re using <code><a href="../reference/mockdb.html">with_mock_db(...)</a></code>) as well as where they are written to (when using <code><a href="../reference/capture_requests.html">start_db_capturing()</a></code>). To do this, use the function [<code><a href="../reference/mockPaths.html">db_mock_paths()</a></code>].</p>
<p>You can see what paths are being used by calling <code><a href="../reference/mockPaths.html">db_mock_paths()</a></code> with no arguments. dittodb will look for mocks in each path starting with the first one. When recording mocks, dittodb always uses the first path that is returned by <code><a href="../reference/mockPaths.html">db_mock_paths()</a></code>.</p>
<p>You can add a new path by calling <code><a href="../reference/mockPaths.html">db_mock_paths("new/path/here")</a></code> which will add the path provided to the top of the list of paths to use.</p>
</div>
<div id="redacting" class="section level3">
<h3 class="hasAnchor">
<a href="#redacting" class="anchor"></a>Redacting</h3>
<p>Sometimes (much? most? of the time!) there is sensitive data in your database that you don’t actually want to put into your test mocks. dittodb allows you to specify columns that should always be redacted by specifying them like so:</p>
<pre><code><a href="../reference/capture_requests.html">start_db_capturing(redact_columns = c("sensitive_column", "other_sensitive_column"))</a></code></pre>
<p>This will always redact the columns “sensitive_column” and “other_sensitive_column” every time a query is recorded that includes either. The redactor replaces every value in the column with a standard value (for example “[redacted]” for characters, <code>9</code> for numerics, <code>1988-10-11T17:00:00</code> for date times) see <code><a href="../reference/redact_columns.html">redact_columns()</a></code> for more information.</p>
</div>
<div id="you-too-can-write-a-snapshot" class="section level3">
<h3 class="hasAnchor">
<a href="#you-too-can-write-a-snapshot" class="anchor"></a>You, too, can write a snapshot!</h3>
<p>When we use <code>start_db_recording()</code> to record snapshots, we are creating what some people call fixtures (though other terms for these abound). These are files that are used during testing to represent and provide some data or state necessary to execute the test. In the case of dittodb, these files contain the data that dittodb uses when it pretends to be a live database. During recording, each query that is sent to the database gets a unique identifier (the first 6 digits of the hash of the query) and when the response is received, that response is saved to a file with the first SQL verb (e.g. <code>SELECT</code>), a dash, and the hash using the <code><a href="https://rdrr.io/r/base/dput.html">dput()</a></code> function. This lets you craft a fixture that tests exactly what you need to without having extraneous rows or columns that might not be relevant.</p>
<p>You can save our own responses for queries by getting figuring out the hash (the easiest way to do this now is to write the test that you want to create a fixture for, run it and see the error message that looks something like “Couldn’t find the file nycflights/SELECT-16d120.R in any of the mock directories.” and use the filename from there.) and then saving the dataframe that you want the test to use with the command <code><a href="https://rdrr.io/r/base/dput.html">dput(df, file = "nycflights/SELECT-16d120.R", control = c("all", "hexNumeric"))</a></code> (if the dataframe you want to save is <code>df</code> and we are using the path we saw in the example error message). And you’ve created your own fixture!</p>
<p>You can also take the approach of recording fixtures and then editing them manually to pare them down. The workflow for that would be something like:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="co"># read in the recorded fixture</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>df_fixt &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"nycflights/SELECT-16d120.R"</span>, <span class="dt">keep.source =</span> <span class="ot">FALSE</span>)<span class="op">$</span>value</span>
<span id="cb11-3"><a href="#cb11-3"></a></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="co"># filter out anything after february and all days after the 9th of the month</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>df_fixt &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(df_fixt, month <span class="op">&lt;=</span><span class="st"> </span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span>day <span class="op">&lt;</span><span class="st"> </span><span class="dv">10</span>)</span>
<span id="cb11-6"><a href="#cb11-6"></a></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="co"># save the fixture for use in tests</span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="kw"><a href="https://rdrr.io/r/base/dput.html">dput</a></span>(df_fixt, <span class="dt">file =</span> <span class="st">"nycflights/SELECT-16d120.R"</span>, <span class="dt">control =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"all"</span>, <span class="st">"hexNumeric"</span>))</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#recording-snapshots">Recording snapshots</a></li>
      <li><a href="#with_mock_db"><code>with_mock_db()</code></a></li>
      <li><a href="#things-to-be-careful-about">Things to be careful about</a></li>
      <li><a href="#advanced-uses">Advanced uses</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jonathan Keane, Mauricio Vargas.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
