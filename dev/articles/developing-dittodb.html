<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Developing {dittodb} • dittodb</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content="Developing {dittodb}">
<meta property="og:description" content="dittodb">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-150741105-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-150741105-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dittodb</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.1.1.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/dittodb.html">Get started</a>
</li>
<li>
  <a href="../reference/">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/dittodb.html">Getting Started with dittodb</a>
    </li>
    <li>
      <a href="../articles/travelling.html">Recording SQL queries with dittodb for travelling</a>
    </li>
    <li>
      <a href="../articles/nycflights.html">nycflights data</a>
    </li>
    <li>
      <a href="../articles/developing-dittodb.html">Developing dittodb</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../news/index.html">Changelog</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Blog posts</li>
    <li>
      <a href="https://jonkeane.com/blog/introducing_dittodb/">dittodb 0.1.0</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ropensci/dittodb/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="developing-dittodb_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Developing {dittodb}</h1>
                        <h4 class="author">Jonathan Keane</h4>
            
            <h4 class="date">2020-09-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/dittodb/blob/main/vignettes/developing-dittodb.Rmd"><code>vignettes/developing-dittodb.Rmd</code></a></small>
      <div class="hidden name"><code>developing-dittodb.Rmd</code></div>

    </div>

    
    
<p>We welcome contributions from anyone, no matter how small or trivial. Documentation additions or typo fixes are especially welcome. For larger, more-functional changes, either see if there is an issue open on GitHub already, or open one with a proposal of the change you would like to make. Please also see our <a href="../docs/CODE_OF_CONDUCT.html">code of conduct</a> and <a href="../docs/CONTRIBUTING.html">contributing guide</a>.</p>
<p>Developing {dittodb} requires is a bit more complication than developing other R packages for a few reasons:</p>
<ol style="list-style-type: decimal">
<li>setting up all of the databases to fully test recording is complicated (which is in some ways the exact reason {dittodb} exists, so you don’t have to do this!)</li>
<li>some of the mechanisms that make {dittodb} work aren’t commonly used in other R packages.</li>
</ol>
<div id="setting-up-databases" class="section level2">
<h2 class="hasAnchor">
<a href="#setting-up-databases" class="anchor"></a>Setting up databases</h2>
<p>In order to fully test that {dittodb} works, we aim to have full coverage and test as many database backends as possible for both recording and using as a mocked database. To do this on continuous integration (CI for short) can be finicky to get working (and on the CI front, we did it once, so that you can use {dittodb} and you won’t have to setup your own database backend just to run tests!). Frankly, even doing this set up locally on a second computer can be a pain! We include in the repository a few scripts that make it (relatively) easy to setup testing database backends, as well as some scripts that we use to setup database backends on GitHub Actions.</p>
<div id="what-we-test" class="section level3">
<h3 class="hasAnchor">
<a href="#what-we-test" class="anchor"></a>What we test</h3>
<p>We currently test against the following database backends with GitHub Actions for CI:</p>
<ul>
<li>Postgres (with drivers: <a href="https://CRAN.R-project.org/package=RPostgres">RPostgres</a>, <a href="https://CRAN.R-project.org/package=RPostgreSQL">RPostgreSQL</a>, and <a href="https://CRAN.R-project.org/package=odbc">odbc</a>)</li>
<li>MariaDB (with driver: <a href="https://CRAN.R-project.org/package=RMariaDB">RMariaDB</a>)</li>
<li>SQLite (with driver: <a href="https://CRAN.R-project.org/package=RSQLite">RSQLite</a>)</li>
</ul>
</div>
<div id="how-to-setup-test-databases-locally" class="section level3">
<h3 class="hasAnchor">
<a href="#how-to-setup-test-databases-locally" class="anchor"></a>How to setup test databases locally</h3>
<p>All of these (with the exception of SQLite) are tested in the test file <code>test-dbi-generic-integration.R</code>. However, tests for each database are only run if specific environment variables are set that trigger them. The reason for this is so that it is easy to test locally without needing to setup databases, but we are covered by these tests being run on GitHub Actions. If you would like to run these tests locally, you can set the following environment variables and run tests as usual (e.g. with <code>R CMD check</code>, <code>devtools::check()</code>, <code>devtools::test()</code>)</p>
<ul>
<li>if <code>DITTODB_ENABLE_PG_TESTS</code> is <code>TRUE</code>, then Postgres-based tests will be run</li>
<li>if <code>DITTODB_ENABLE_MARIA_TESTS</code> is <code>TRUE</code>, then MariaDB-based tests will be run</li>
</ul>
<p>There are a few scripts included in the <code>db-setup</code> folder that are helpful for setting up databases. For local tests, we highly recommend using the docker scripts:</p>
<ul>
<li>
<code>db-setup/local-mariadb-docker-setup.sh</code> which starts (or stops and then starts if it’s already running) a docker container, installs MariaDB in that container (running on the default port 3306), and loads the correct test user and test data into the database for running tests.</li>
<li>
<code>db-setup/local-postgres-docker-setup.sh</code> which starts (or stops and then starts if it’s already running) a docker container, installs Postgres in that container (running on the default port 5432), and loads the correct test user and test data into the database for running tests.</li>
</ul>
<p>If you’ve already got databases running on the default ports (3306 for MariaDB and 5432 for Postgres) and you want to use the docker scripts, we recommend that you change the ports that docker is using for any databases you’re already running. You can use the <code>DITTODB_MARIA_TEST_PORT</code> and <code>DITTODB_PG_TEST_PORT</code> environment variables to change which port {dittodb} uses to connect to the test databases. The docker scripts above will use these environment variables to map ports if they are set (and exported) for convenience. One thing to note: during {dittodb} tests, if some database drivers attempt to connect to not-running or on-the-wrong-port database backends, they can segfault instead of erroring with a more informative error. If you see this, the first thing to check is that the port variables are being set correctly and that the database backend is up and running normally.</p>
<p>Both of these utilize a few SQL (Structured Query Language) scripts for their respective backends. These might be useful if you’re manually adding the test data into a database you already have running, but if you’re using the docker scripts above, you shouldn’t need to use them at all.</p>
<ul>
<li>
<code>db-setup/[mariadb|postgres]-reset.sql</code> creates the database <code>nycflights</code> and test users (dropping them if they already exist so they are fresh).</li>
<li>
<code>db-setup/[mariadb|postgres]-nycflights.sql</code> creates the necessary tables in the <code>nycflights</code> database for use in testing.</li>
<li>
<code>db-setup/populate-dbs.sh</code> uses the above scripts to populate the databases on GitHub Actions.</li>
</ul>
</div>
<div id="what-not-to-run-️" class="section level3">
<h3 class="hasAnchor">
<a href="#what-not-to-run-%EF%B8%8F" class="anchor"></a>☠️ What not to run ☠️</h3>
<p>The other scripts (e.g. <code>db-setup/[mariadb|postgres]-brew.sh</code> and <code>db-setup/[mariadb|postgres]-docker-container-only.sh</code>) are only intended for use on GitHub Actions and should not be run locally. They include commands that will remove files necessary to reset database setups that allow for tests to be run. Running them locally will delete files that you might care about.</p>
</div>
</div>
<div id="some-of-the-tricky-bits-that-dittodb-uses" class="section level2">
<h2 class="hasAnchor">
<a href="#some-of-the-tricky-bits-that-dittodb-uses" class="anchor"></a>Some of the tricky bits that {dittodb} uses</h2>
<p>In order to provide a seamless experience between using a real database connection and using the mocked version of the database {dittodb} uses some features of R that are pretty uncommon. This is not intended to be a comprehensive description of {dittodb}’s architecture, but a few things that are uncommon or a little strange.</p>
<div id="recording" class="section level3">
<h3 class="hasAnchor">
<a href="#recording" class="anchor"></a>Recording</h3>
<p>In order to record fixtures while using a real database connection, we use <code><a href="https://rdrr.io/r/base/trace.html">base::trace()</a></code> to add code that inspects the queries (to define unique hashes) and saves the results so that they can be used later. This tracing only happens when using the <code><a href="../reference/capture_requests.html">start_db_capturing()</a></code> functions and should generally not be used during testing by packages that use {dittodb}. Rather, this functionality should generally be used to see what interactions a piece of code to be tested is having with a database and either use or edit and use the fixtures it produces in testing.</p>
</div>
<div id="using-a-mocked-database" class="section level3">
<h3 class="hasAnchor">
<a href="#using-a-mocked-database" class="anchor"></a>Using a mocked database</h3>
<p>When using fixtures (i.e. with a mocked database), we use <code><a href="https://testthat.r-lib.org/reference/with_mock.html">testthat::with_mock()</a></code> and some internals to mock the <code><a href="https://dbi.r-dbi.org/reference/dbConnect.html">DBI::dbConnect()</a></code> function and replace the true connection with a special mock connection class from {dittodb} (<code>DBIMockConnection</code>, though there are specific sub-classes for some drivers, e.g. <code>DBIMockRPostgresConnection</code>). Then {dittodb} relies on standard S4 method dispatch to find the appropriate fixture for queries being run during testing.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://jonkeane.com/">Jonathan Keane</a>, <a href="https://pacha.dev/">Mauricio Vargas</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
