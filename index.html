<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A Test Environment for DB Requests • dbtest</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="A Test Environment for DB Requests">
<meta property="og:description" content="Testing and documenting code that communicates with remote
  databases can be painful. Dealing with authentication, server state,
  and other complications can make testing seem too costly to
  bother with. But it doesn't need to be that hard. This package enables one
  to test all of the logic on the R sides of the database in your package
  without requiring access to the remote service. It also allows one to safely
  record real query results to use as test fixtures. The ability to save
  query results and load them offline also enables one to write vignettes and
  other dynamic documents that can be distributed without access to a live
  server.">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">dbtest</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jonkeane/dbtest">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="dbtest" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#dbtest" class="anchor"></a>dbtest</h1></div>
<!-- badges: start -->

<p>dbtest is a package that makes testing against databases easy. When writing code that relies on interactions with databases, testing has been difficult without recreating test databases in your CI environment, or resorting to using SQLite databases instead of the database engines you have in production. Both have their downsides: recreating database infrastructure is slow, error prone, and hard to iterate with. Using SQLite works well, right up until you use a feature (like <a href="https://www.sqlite.org/omitted.html">a full outer join</a>) or has <a href="https://www.sqlite.org/quirks.html">quirks</a> that might differ from your production database. dbtest solves this by recording database interactions, saving them as mocks, and then replaying them seamlessly during testing. This means that if you can get a query from your database, you can record the response and reliably reproduce that response in tests.</p>
<p>dbtest is heavily inspired by <a href="https://CRAN.R-project.org/package=httptest">httptest</a>, if you’ve used httptest before, you’ll find many of the interactions similar.</p>
<div id="a-quick-example" class="section level2">
<h2 class="hasAnchor">
<a href="#a-quick-example" class="anchor"></a>A quick example</h2>
<p>Say we have a Postgres database with some <a href="https://CRAN.R-project.org/package=nycflights13">nycflights</a> data in it and we are writing functions that query this data that we want to test.</p>
<p>For example, we have the simple function that retrieves one airline:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">get_an_airline &lt;-<span class="st"> </span><span class="cf">function</span>(con) {</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw">dbGetQuery</span>(con, <span class="st">"SELECT carrier, name FROM airlines LIMIT 1"</span>))</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">}</a></code></pre></div>
<p>But we want to make sure that this function returns what we expect. To do this, we first record the response we get from the production database:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="reference/capture_requests.html">start_capturing</a></span>()</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">con &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DBI/man/dbConnect.html">dbConnect</a></span>(</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  RPostgres<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/RPostgres/man/Postgres.html">Postgres</a></span>(),</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  <span class="dt">dbname =</span> <span class="st">"nycflights"</span>,</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  <span class="dt">host =</span> <span class="st">"127.0.0.1"</span>,</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  <span class="dt">user =</span> <span class="st">"travis"</span>,</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">  <span class="dt">password =</span> <span class="st">""</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">)</a>
<a class="sourceLine" id="cb2-10" data-line-number="10"></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="kw">get_an_airline</span>(con)</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">DBI<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DBI/man/dbDisconnect.html">dbDisconnect</a></span>(con)</a>
<a class="sourceLine" id="cb2-13" data-line-number="13"></a>
<a class="sourceLine" id="cb2-14" data-line-number="14"><span class="kw"><a href="reference/capture_requests.html">stop_capturing</a></span>()</a></code></pre></div>
<p>This will run the query from <code>get_an_airline()</code>, and save the response in a mock directory and file. Then, when we are testing, we can use the following:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># With RPostgres package</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw"><a href="reference/with_mock_db.html">with_mock_db</a></span>({</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">  con &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DBI/man/dbConnect.html">dbConnect</a></span>(</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">    RPostgres<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/RPostgres/man/Postgres.html">Postgres</a></span>(),</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">    <span class="dt">dbname =</span> <span class="st">"nycflights"</span>,</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">    <span class="dt">host =</span> <span class="st">"127.0.0.1"</span>,</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">    <span class="dt">user =</span> <span class="st">"travis"</span>,</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">    <span class="dt">password =</span> <span class="st">""</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9">  )</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb3-11" data-line-number="11">  <span class="kw">test_that</span>(<span class="st">"We get one airline"</span>, {</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">    one_airline &lt;-<span class="st"> </span><span class="kw">get_an_airline</span>()</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">    <span class="kw">expect_is</span>(one_airline, <span class="st">"data.frame"</span>)</a>
<a class="sourceLine" id="cb3-14" data-line-number="14">    <span class="kw">expect_equal</span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(one_airline), <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">    <span class="kw">expect_equal</span>(one_airline<span class="op">$</span>carrier, <span class="st">"9E"</span>)</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">    <span class="kw">expect_equal</span>(one_airline<span class="op">$</span>name, <span class="st">"Endeavor Air Inc."</span>)</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">  })</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">})</a></code></pre></div>
<p>All without having to ever set a database up on Travis 🎉</p>
<p>Alternatively, any other driver could be used:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="reference/capture_requests.html">start_capturing</a></span>()</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">con &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DBI/man/dbConnect.html">dbConnect</a></span>(</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  <span class="dt">drv =</span> DBI<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DBI/man/dbDriver.html">dbDriver</a></span>(<span class="st">"PostgreSQL"</span>),</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">  <span class="dt">dbname =</span> <span class="st">"nycflights"</span>,</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">  <span class="dt">host =</span> <span class="st">"127.0.0.1"</span>,</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">  <span class="dt">user =</span> <span class="st">"travis"</span>,</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">  <span class="dt">password =</span> <span class="st">""</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9">)</a>
<a class="sourceLine" id="cb4-10" data-line-number="10"></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="kw">get_an_airline</span>(con)</a>
<a class="sourceLine" id="cb4-12" data-line-number="12">DBI<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DBI/man/dbDisconnect.html">dbDisconnect</a></span>(con)</a>
<a class="sourceLine" id="cb4-13" data-line-number="13"></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="kw"><a href="reference/capture_requests.html">stop_capturing</a></span>()</a></code></pre></div>
<p>and then</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="reference/with_mock_db.html">with_mock_db</a></span>({</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  con &lt;-<span class="st"> </span>RPostgreSQL<span class="op">::</span><span class="kw">dbConnect</span>(</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">    <span class="dt">drv =</span> DBI<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DBI/man/dbDriver.html">dbDriver</a></span>(<span class="st">"PostgreSQL"</span>),</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">    <span class="dt">dbname =</span> <span class="st">"nycflights"</span>,</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">    <span class="dt">host =</span> <span class="st">"127.0.0.1"</span>,</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">    <span class="dt">user =</span> <span class="st">"travis"</span>,</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">    <span class="dt">password =</span> <span class="st">""</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">  )</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">  </a>
<a class="sourceLine" id="cb5-10" data-line-number="10">  <span class="kw">test_that</span>(<span class="st">"We get one airline"</span>, {</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">    one_airline &lt;-<span class="st"> </span><span class="kw">get_an_airline</span>()</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">    <span class="kw">expect_is</span>(one_airline, <span class="st">"data.frame"</span>)</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">    <span class="kw">expect_equal</span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(one_airline), <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">    <span class="kw">expect_equal</span>(one_airline<span class="op">$</span>carrier, <span class="st">"9E"</span>)</a>
<a class="sourceLine" id="cb5-15" data-line-number="15">    <span class="kw">expect_equal</span>(one_airline<span class="op">$</span>name, <span class="st">"Endeavor Air Inc."</span>)</a>
<a class="sourceLine" id="cb5-16" data-line-number="16">  })</a>
<a class="sourceLine" id="cb5-17" data-line-number="17">})</a></code></pre></div>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>Currently, dbtest is not on CRAN. You can install from source, or use <code>devtools</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">"jonkeane/dbtest"</span>)</a></code></pre></div>
<hr>
<p>Please note that the ‘dbtest’ project is released with a <a href="CODE_OF_CONDUCT.html">Contributor Code of Conduct</a>. By contributing to this project, you agree to abide by its terms.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Browse source code at <br><a href="https://github.com/jonkeane/dbtest">https://​github.com/​jonkeane/​dbtest</a>
</li>
<li>Report a bug at <br><a href="https://github.com/jonkeane/dbtest/issues">https://​github.com/​jonkeane/​dbtest/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small>Apache License (&gt;= 2.0)</small></li>
</ul>
</div>
<div class="community">
<h2>Community</h2>
<ul class="list-unstyled">
<li><a href="CODE_OF_CONDUCT.html">Code of conduct</a></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Jonathan Keane <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0001-7087-9776" target="orcid.widget"><img src="https://members.orcid.org/sites/default/files/vector_iD_icon.svg" class="orcid" alt="ORCID"></a> </li>
<li>Mauricio Vargas <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0003-1017-7574" target="orcid.widget"><img src="https://members.orcid.org/sites/default/files/vector_iD_icon.svg" class="orcid" alt="ORCID"></a> </li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://travis-ci.org/jonkeane/dbtest"><img src="https://travis-ci.org/jonkeane/dbtest.svg?branch=master" alt="Travis build status"></a></li>
<li><a href="https://codecov.io/gh/jonkeane/dbtest?branch=master"><img src="https://codecov.io/gh/jonkeane/dbtest/branch/master/graph/badge.svg" alt="Codecov test coverage"></a></li>
<li><a href="https://www.tidyverse.org/lifecycle/#experimental"><img src="https://img.shields.io/badge/lifecycle-experimental-orange.svg" alt="Lifecycle: experimental"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Jonathan Keane, Mauricio Vargas.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
